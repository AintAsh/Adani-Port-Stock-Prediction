# -*- coding: utf-8 -*-
"""Stock_Advanced_ML_Models_ADANIPORTS.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NXN-Fd98DuPHDf_Lzo1FzGyi4eZ9i-IC
"""

import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

# Load dataset
df = pd.read_csv('ADANIPORTS.csv')

# Convert Date and sort
df['Date'] = pd.to_datetime(df['Date'])
df = df.sort_values('Date').reset_index(drop=True)

df.head()

# Create target columns
df['Next_Day_Close'] = df['Close'].shift(-1)
df['Next_Day_Return'] = (df['Next_Day_Close'] - df['Close']) / df['Close']

df = df.dropna()
df[['Date','Close','Next_Day_Close','Next_Day_Return']].head()

# Feature selection
features = ['Prev Close','Open','High','Low','Close','Volume']
target = 'Next_Day_Close'

X = df[features]
y = df[target]

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, shuffle=False
)

X_train.shape, X_test.shape

# Linear Regression
from sklearn.linear_model import LinearRegression

lr = LinearRegression()
lr.fit(X_train, y_train)
pred_lr = lr.predict(X_test)

print("Linear Regression")
print("R2:", r2_score(y_test, pred_lr))
print("MAE:", mean_absolute_error(y_test, pred_lr))
print("RMSE:", mean_squared_error(y_test, pred_lr))

# Decision Tree Regressor
from sklearn.tree import DecisionTreeRegressor

dt = DecisionTreeRegressor(max_depth=8, random_state=42)
dt.fit(X_train, y_train)
pred_dt = dt.predict(X_test)

print("Decision Tree")
print("R2:", r2_score(y_test, pred_dt))
print("MAE:", mean_absolute_error(y_test, pred_dt))
print("RMSE:", mean_squared_error(y_test, pred_dt))

# Random Forest Regressor
from sklearn.ensemble import RandomForestRegressor

rf = RandomForestRegressor(
    n_estimators=200,
    max_depth=10,
    random_state=42,
    n_jobs=-1
)
rf.fit(X_train, y_train)
pred_rf = rf.predict(X_test)

print("Random Forest")
print("R2:", r2_score(y_test, pred_rf))
print("MAE:", mean_absolute_error(y_test, pred_rf))
print("RMSE:", mean_squared_error(y_test, pred_rf))

# Model comparison
results = pd.DataFrame({
    'Model': ['Linear Regression', 'Decision Tree', 'Random Forest'],
    'R2 Score': [
        r2_score(y_test, pred_lr),
        r2_score(y_test, pred_dt),
        r2_score(y_test, pred_rf)
    ],
    'MAE': [
        mean_absolute_error(y_test, pred_lr),
        mean_absolute_error(y_test, pred_dt),
        mean_absolute_error(y_test, pred_rf)
    ],
    'RMSE': [
        mean_squared_error(y_test, pred_lr),
        mean_squared_error(y_test, pred_dt),
        mean_squared_error(y_test, pred_rf)
    ]
})

results

# Use predictions from your trained model
# y_test -> actual values
# pred_lr -> predicted values (Linear Regression)

plt.figure(figsize=(12, 6))
plt.plot(y_test.values, label='Actual Price', linewidth=2)
plt.plot(pred_lr, label='Predicted Price', linestyle='--')

plt.title('Actual vs Predicted Stock Price (Linear Regression)')
plt.xlabel('Time')
plt.ylabel('Stock Price')
plt.legend()
plt.grid(True)
plt.show()

import pickle as pk
pk.dump(lr,open('Stock_Prediction.pkl','wb'))

